# AGENTS.md – rm-booking-curve-lab 向け AI 用ルール

この文書は、rm-booking-curve-lab リポジトリで作業する **AIエージェント**
（例: ChatGPT, GitHub Copilot, Codex 等）に対するルールです。

ここに書かれていることは、一般的なコーディングスタイルや
「良かれと思った判断」よりも **優先順位が高い** ものとします。

---

## 0. 参照すべきドキュメント（唯一の正の整理）

このプロジェクトでは、仕様・設計・運用ルールはリポジトリ内の docs を
**「唯一の正（Single Source of Truth）」** として扱います。

AIエージェントは、以下のファイルを優先的に参照してください。

### 0-1. 仕様（外部仕様・ロジック定義の唯一の正）
- `docs/spec_overview.md`
- `docs/spec_data_layer.md`
- `docs/spec_models.md`
- `docs/spec_evaluation.md`

### 0-2. AI運用ルール（本書と併せて従う）
- `AGENTS.md`（本書）
- `docs/dev_style.md`（開発運用OS：ZIP共有、スレッド運用、壁打ちルール 等）

### 0-3. 計画（予定。現状挙動の根拠にしない）
- `docs/roadmap.md`
- `docs/tasks_backlog.md`

### 0-4. 利用者向け操作説明
- `BookingCurveLab_README.txt`

**重要：**
- 仕様に迷ったら、まず `docs/spec_*.md` を読み、そこに書かれていないことだけを推論してください。
- 仕様とコードが矛盾しているように見える場合は、「仕様が優先」の前提で扱い、疑問点をコメントやTODOとして残してください。
- `roadmap.md` / `tasks_backlog.md` は **計画** です。現状挙動の根拠にしないでください。

---

## 0.5 実装の品質ゲート（推測で進めない）

AIエージェントは、以下を必ず守ってください。

- 判断に必要なファイルが足りていない場合は、**推測で進めずに要求**してください。
- 仕様（`docs/spec_*.md`）と対象コードを **必ず確認** し、参照せずに断定しないでください。
- まだ不足している情報がある場合は、**推測で実装を進めず**、必要な情報（入力例・期待出力・再現手順など）を要求してください。
- 追加質問が必要な場合は、**最大5つ**に絞って提示してください。
- 情報不足の状態で「修正後のフルコード」を出して問題を隠蔽しないこと（不確かな場合は要求に戻す）。

### 0.5.1 共有ファイル（ZIP）運用ルール
- 共有ファイルは **`make_release_zip.py` で作成した最新ZIP** を唯一の正とし、手作業の単体ファイル添付は原則しない。
- ZIP に含める `output/` やログ等のサンプルは、**必ず個人情報・企業機密を排したダミーのみ**（例外なし）。

---

## 1. プロジェクトの目的と前提

- このプロジェクトは、ホテルの **ブッキングカーブ／リードタイム(LT)** を用いて、
  予約推移と宿泊実績を可視化し、簡易な予測（forecast）と評価を行うツールです。
- PMS（N@FACE）由来のデータを、
  `daily_snapshots → LT_DATA → 評価用データ → グラフ・レポート`
  の一貫したパイプラインで扱います（詳細は `spec_data_layer.md`）。
- GUI（Tkinter）・CLIスクリプト・共通モジュールをすべて **Python** で実装します。
- Windows 環境での EXE 配布を前提とし、依存追加は慎重に扱います。
- 複数ホテル対応・複数モデル対応・ASOF比較を前提とします。

---

## 2. 役割分担：ChatGPT vs Codex

### 2.1 ChatGPT の役割（参謀）
- 仕様・設計・要件の整理
- `docs/*.md`（仕様書・ロードマップ・タスク・運用OS）の草案作成／更新案
- Codex に渡すプロンプト（タスク定義）の設計
- コードレビュー（仕様との整合・設計リスク・バグ筋）
- README / 引き継ぎ等のドキュメント生成

### 2.2 Codex / コード生成エージェントの役割（実装）
- 既存仕様に基づくコード実装・修正・リファクタリング
- テストコードの追加・修正
- 評価やバッチ処理などのスクリプト実装
- コメント・docstring の追加（仕様の補足レベルにとどめる）

**原則：**
- `docs/` の仕様書は **参照専用**（編集は原則しない）。
- 実装は共通モジュール側に寄せ、GUI/CLIは薄く保つ。

---

## 3. docs/ の編集ルール

### 3.1 誰が編集してよいか
- `docs/spec_overview.md`
- `docs/spec_data_layer.md`
- `docs/spec_models.md`
- `docs/spec_evaluation.md`
- `docs/roadmap.md`
- `docs/tasks_backlog.md`
- `docs/dev_style.md`

これらは、**原則として人間と ChatGPT が編集**します。

Codex は：
- 上記ファイルを **読み取り専用** とみなしてください。
- 仕様・設計・タスクの文言を変更・削除しないでください。

### 3.2 例外（Codex が触ってよいケース）
プロジェクトオーナーが明示的に指示した場合のみ、以下は例外として許可されます。

- 特定セクションに「表やサマリを追記する」などの **追加専用タスク** を行う場合  
  例：「`spec_evaluation.md` の末尾に、最新の評価指標サマリ表だけ追記して」

ただし：
- 既存の文章・見出し・構造を変更しないこと
- 人間が必ず差分をレビューしてからマージすること

---

## 4. コード構成と責務（概要）

※詳細は `spec_overview.md` / `spec_data_layer.md` を優先。

- `src/gui_main.py` / `booking_curve/gui_backend.py`
  - Tkinter GUI のイベント／画面制御（ビジネスロジックを極力書かない）
- `booking_curve/daily_snapshots.py`
  - PMSデータから daily snapshots を構築するロジック
- `booking_curve/lt_builder.py`
  - daily snapshots や（旧）時系列Excelから LT_DATA を構築するロジック
- `booking_curve/forecast_simple.py`
  - avg / recent90 / recent90w など LT ベースの予測モデル群
- `src/run_*.py` / `src/build_*.py` など
  - CLI用エントリポイント（引数を読み、共通ロジックを呼び、CSV/PNG等を出力）

---

## 5. 実装・リファクタ時の基本ルール

- 命名：
  - 変数名・関数名は英語で、役割が分かる名前にする
  - マジックナンバーは定数化（または設定化）
- Lint/Format：
  - `ruff` 前提。未使用import・未使用変数などを残さない
- 例外処理：
  - 読み込みなど失敗しうる箇所は適切に try/except
  - 安易な `except Exception: pass` は禁止
- 依存追加：
  - 標準ライブラリで代替可能ならそちらを優先
  - 新規ライブラリが必要なら、まず提案（理由・影響・代替案）を示す

---

## 6. 仕様変更とコード変更のフロー

### 6.1 仕様を変えたいとき（正しい順番）
1. ChatGPT とユーザーが仕様変更を議論する
2. ChatGPT が `spec_*.md`（必要なら `roadmap` / `tasks_backlog`）の修正案を生成
3. ユーザーが内容を確認し docs を更新
4. `docs/tasks_backlog.md` にタスクID（例：`P1-01`）を追加／更新
5. タスクIDを前提とした Codex 用プロンプトで実装を依頼

### 6.2 コード改善から仕様に反映したいとき
1. Codex が仕様に反さない範囲で実装を変更
2. 変更内容（挙動差分）をChatGPTが整理
3. ChatGPTが仕様への反映案を作成
4. ユーザーがレビューしてdocsを更新

### 6.3 スレッド終了ゲート（Thread Log / Decision Log）

スレッドを跨いで開発が進む場合、**スレッド終了時に必ず以下を実施**する（コンテキスト崩壊対策）。

1. **Thread Log を作成（append-only）**
   - 出力先：`docs/thread_logs/YYYY-MM-DD_<branch>_<short>.md`
   - 必須項目：Branch / Commit / Zip（packagesのZIP名）/ Scope / Done / Decisions / Docs impact / Open / Next
   - 注意：Thread Log は**仕様ではなく作業記録**。仕様の唯一の正は `docs/spec_*.md`。

2. **Decision Log を更新（決定のみ）**
   - 出力先：`docs/decision_log.md`
   - 追記対象：スレッドを跨いでも効く「以後こうする」決定（閾値、保存先、定義変更など）
   - 各決定に **Spec link（反映先spec）** と **Status（spec反映済/未反映）** を付ける

3. **Docs impact の棚卸し**
   - spec更新が必要なら、ChatGPTは **差分案（コピペ可能）** を作成し、ユーザーが docs を更新する
   - 禁止：Decision Log や Thread Log を“仕様の代わり”として扱うこと

### 6.4 スレッド移行ゲート（引き継ぎ受領時の必須確認）

スレッドを跨いで作業を継続する際、参照齟齬を防ぐため **新スレッド開始時に必ず以下を確認**する。

1. **最新ZIPを唯一の正として展開し、直近ログを確認**
   - `docs/thread_logs/` のうち **直近のThread Log（原則1本）**
   - `docs/decision_log.md` の **末尾（直近10〜20件）**
2. **引継書とログ・コード仕様の整合を検算**
   - 矛盾／不明点があれば、推測で埋めずに「確認質問」を作成する
3. **確認質問の作り方（固定ルール）**
   - 質問は最大5つ
   - Yes/No または短文で答えられる形を優先
   - “前提の確定” が目的。議論を呼ぶ質問（論点追加）は避ける
4. **ログ未整備時の扱い**
   - Thread Log / Decision Log が未更新なら、作業を進める前に不足として指摘し、必要なら先に作成する

**禁止：**
- Codex が docs を勝手に編集して仕様を合わせにいくこと
- 仕様更新なしに実装だけで大きく挙動を変えること

---

## 7. Codex 用プロンプト生成ルール（ChatGPT向け）

ChatGPT が Codex 用プロンプトを生成するときは、以下を必ず含める：

1. 目的（What & Why）
2. 参照すべき仕様ファイル（`spec_*` など）
3. タスクIDとスコープ（今回触る範囲を固定）
4. 変更対象ファイル
5. 完了条件（互換性、出力、テストなど）
6. 制約（docsはread-only、ruff、Tkinter維持 等）

**追加ルール：**
- 判断材料（コード／仕様／入力例）が不足している場合、プロンプトは出さず、必要ファイルの要求または壁打ちに切り替える。

---

## 8. モデル・評価ロジックに関する注意
- モデル定義（avg / recent90 / recent90w など）は必ず `docs/spec_models.md` に従う。
- 指標（Bias, MAPE, MPE, RMSE など）の定義と集計仕様は `docs/spec_evaluation.md` に従う。
- 新しいモデル／指標の追加は、まず仕様合意と docs 更新を行ってから実装する。

---

## 9. 禁止事項（Do NOT）
AIエージェントは、以下をしてはいけません。

1. `docs/spec_*.md` を読まずに、モデルロジックや列定義を勝手に再定義すること
2. テストが落ちている状態を放置して「完了」とすること
3. ASOF / ACT の扱いを誤解したままロジックを変更すること
4. GUIフレームワークを Tkinter 以外に変更すること
5. 何もしないダミー関数・クラスを増やすこと
6. 環境依存のパスや設定をベタ書きすること
7. CSVの列構成・意味を理由なく変更すること
8. Codex用プロンプトのフォーマットを独自に変え、再利用性を下げること
9. `docs/` 以下の仕様書を、明示的な許可なく書き換えること
10. 実データ（個人情報・企業機密の可能性があるデータ）をサンプルとして共有ZIPに同梱すること
11. 共有の唯一の正（最新ZIP）を無視して、断片的な単体ファイルだけで判断を進めること

---

以上のルールを守ったうえで、rm-booking-curve-lab の品質と一貫性を維持しつつ、
コード生成・修正・設計支援を行ってください。
