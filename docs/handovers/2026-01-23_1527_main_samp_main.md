Proposed file path: docs/handovers/2026-01-23_1527_main_samp_main.md

# スレッド移行：引き継ぎ（正本）

これは「引き継ぎ書」そのものです。
あなたの最初の仕事は “この引き継ぎを受領して状況を理解すること” であり、
引き継ぎ文の添削・再構成・改善提案ではありません（編集対象ではなく参照用）。

---

## 0. メタ情報

* 最新ZIP（唯一の正）: `rm-booking-curve-lab_20260123_1524_samp_main_2e5b3ac_full.zip`
* Branch: `main`
* Commit: `2e5b3ac`
* Scope: `samp_main`
* 状態: **リリース済（GitHub Releases）**

---

## 1. このスレッドの目的

* Phase3 前に、既知のクラッシュ/不整合/フリーズ系を潰して **main リリース**する。
* とくに「TopDownRevPAR が日別Forecastの状態を汚染して数値が壊れる」系の再現事象を解消する。

---

## 2. 完了したこと（今回の成果）

### A. TopDownRevPAR と月次サマリ不一致（実質バグ）を解消

* TopDownRevPAR表示がトリガーとなり、日別Forecast側の表示切替・丸めON/OFFで **予測OCCが一律（例: 38.7%）になる**等の状態汚染が発生していた事象を解消。
* TopDownRevPAR下部の診断テーブル（Forecast RevPAR と p10–p90 比較）に、**FcRevPARの根拠列（FcADR / FcOcc% / FcRooms / FcRev / cap / days）**を追加して、根拠一致の検証が可能に。

### B. 例外落ち（U-004系）のコードチェック対象

* 「recent90×カレンダーCSV欠損で落ちる件」「3月Forecast実行で落ちる件（gui_app.log例外）」は、前段で修正済みという前提で、今回スレッドでは主にコード健全性・連鎖不具合の観点を確認。

### C. ブッキングカーブタブ：LT_DATA更新のフリーズ回避

* LT_DATA(4ヶ月) / LT_DATA(期間指定) 実行時に、準備フェーズで進捗ダイアログ（例:「LT_DATA準備中」）を出しつつ処理を分離し、UIが固まり続ける問題を回避できる状態を確認。

### D. Daily snapshots 全量再生成メッセージ（概算時間）

* 概算時間の乖離が大きかったため、表示を現実的な形に修正（※「概算秒」表示の扱いを見直し）。修正確認済。

---

## 3. 主要変更点（当たり箇所の目安）

* TopDownRevPAR / 予測ロジック連携（状態汚染回避、診断列追加）

  * `src/booking_curve/gui_backend.py`
  * `src/gui_main.py`
* LT_DATA 更新フリーズ回避（準備処理の分離・進捗UI）

  * `src/gui_main.py`（`_on_build_lt_data`, `_on_build_lt_data_range`, `_run_lt_data_prepare` 周辺）
* Daily snapshots 全量再生成メッセージ文言/表示

  * `src/gui_main.py`（全量再生成の確認ダイアログ周辺）

---

## 4. 動作確認（スモーク）

* TopDownRevPAR:

  * TopDownを開いた後に、日別Forecast画面で「表示切替」「丸めON/OFF」をしても、予測OCCが一律値に崩れない。
  * TopDown下部診断テーブルの FcADR/FcOcc% 等がサマリの根拠と整合する。
* LT_DATA:

  * 実行直後に「LT_DATA準備中」等の表示が出て、UIが固まり続けない。
* Daily snapshots 全量:

  * 確認メッセージが過度に乖離した概算時間を出さない（/現実的な表示になっている）。

---

## 5. 仕様・運用上の扱い（重要）

* 「TopDownRevPAR と月次サマリは、丸め後まで一致させる必要はない」が、**丸め前の根拠・前提・予測値は一致しているべき**、という整理で進めた。
* 予測の一致条件（今回の検証軸）:

  * 予測モデルの一致（GUI選択）
  * ASOFの一致
  * 予測根拠（ADR/OCC/Rooms/Rev等の前提）の一致
  * 予測値（丸め前）の一致

---

## 6. 未決・保留（次スレッドへ）

### 次スレッドのタスク（ユーザー指定）

* `pace14_market` の **market補正を線形→power** に修正検討
* 同時に、**clip が安全寄りすぎる**点を調整（範囲/優先順位/ガードの再設計含む）
* まずはブランチを切るところから開始

---

## 7. 既知の論点（今回スレッド内の残り香）

* `bADR / bOcc` は `FcADR / FcOcc%` と同値になっており、**表示上は冗長**。
  → 次回のUI整理で「非表示（列削除）」にして良い（ユーザー合意ベース）。

---

## 8. リリース情報

* リリース済（GitHub Releases）
* ZIP（唯一の正）: `rm-booking-curve-lab_20260123_1524_samp_main_2e5b3ac_full.zip`
* Branch/Commit: `main` / `2e5b3ac`

---

## 9. 次担当の最初の一手（推奨の作業順）

1. `main` から `feature/pace14_market_power_and_clip`（仮）を作成
2. `pace14_market` の market_factor 設計を power 化（式・パラメータの固定方針）
3. clip 方針の見直し（市場側clip / PF側clip / 最終ガードの優先順位）
4. docs（spec_* / AGENTS.md）への反映箇所を特定して、決定→固定へ

---

## 10. Questions（不足がある場合のみ）

（なし）

---