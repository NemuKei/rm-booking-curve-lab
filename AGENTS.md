# AGENTS.md – rm-booking-curve-lab 向け AI 用ルール

この文書は、rm-booking-curve-lab リポジトリで作業する **AIエージェント
（例: ChatGPT, GitHub Copilot, Codex 等）** に対するルールです。

ここに書かれていることは、一般的なコーディングスタイルやあなた自身の
「良かれと思った判断」よりも **優先順位が高い** ものとします。

---

## 1. プロジェクトの目的と前提

- このプロジェクトは、ホテルの **ブッキングカーブ／リードタイム(LT) データ** を用いて、
  予約推移と宿泊実績を可視化し、簡易な予測（forecast）と評価を行うツールです。
- GUI（Tkinter）・CLI スクリプト・共通モジュールをすべて **Python** で実装します。
- ユーザーは複数ホテルを管理しており、将来的にホテル数や評価ロジックが増える前提です。
- 標準CSVフォーマットや GUI の入出力仕様は、他ツールとの互換性を持つ **外部仕様** として扱い、
  互換性を壊す変更は行わないか、行う場合は明示的なマイグレーションを伴うものとします。

---

## 2. 使用技術の制約

- 言語は **Python のみ** を使用してください。
- 既存コードで使っているライブラリ以外を導入したい場合は、  
  まず既存の import を読んで、「本当に必要か」を検討してください。
  - どうしても外部ライブラリを追加する場合は、`requirements.txt` や `pyproject.toml` などの
    依存定義ファイルも忘れずに更新してください。
- OS依存の挙動（絶対パスのベタ書き、Windows 専用APIなど）は原則禁止です。
  - パス・環境依存の設定値は、`pathlib` や設定ファイル（例: JSON, YAML）経由で扱ってください。
- GUI は **Tkinter** 前提です。別フレームワーク（PyQt, Kivy など）に差し替えないでください。

---

## 3. ファイル・モジュールに関する方針

- `booking_curve/` 配下は **共通ロジックのモジュール** です。  
  GUI だけでなく CLI スクリプトもここを利用しています。
  - ここにある関数・クラスのシグネチャ（引数・戻り値）は、  
    既存コードとの互換性をできる限り維持してください。
- `gui_*.py` は **GUI レイヤー** です。  
  画面レイアウト・ボタン操作・グラフ描画 ロジックはここに集約します。
  - 例：`src/gui_main.py` など。
- `run_*.py` は **CLI 用ランナー** です。  
  可能な限り「共通モジュールの呼び出し」に専念させ、  
  複雑な処理は `booking_curve/` 側へ移すようにしてください。
- **新しい機能を追加するときは、まず共通モジュール側に小さな関数を追加し、  
  それを GUI／CLI から呼び出す構造を優先**してください。
- 標準CSV（縦持ち）や LT_DATA CSV の列構成・型は、他ツールからも参照されるため、
  **列名・型・意味を勝手に変更しないでください。**
  変更が必要な場合は、既存の列を残した上で新列を追加するなど、後方互換性を考慮してください。

---

## 4. 既存仕様に関する重要ルール

以下は、このプロジェクト特有の「壊すとやばい」仕様です。

- **ASOF（ある時点での確定済みデータ）に関する扱い**
  - ASOF より先の日付について、ACT が存在しないにも関わらず
    予測や実績が「埋まっている」ような挙動を作らないでください。
  - ASOF をまたいだ補完ロジックを変更する場合は、  
    必ずテストを追加し、その意図をコメントで説明してください。
  - 関連ロジックを変更する場合は、必ず
    `booking_curve/lt_builder.py` や `booking_curve/forecast_simple.py` を読んでから行ってください。
- **ACT / 予測カーブの描画**
  - グラフ上で ACT は「ASOF 時点までの実績」で止まることが重要です。
  - 未着地部分を勝手に実線で延長せず、仕様に反する描画は行わないでください。
- **モデルロジック（avg / recent90 / recent90w など）**
  - これらの定義は、既存コードにすでに実装・コメントがあります。
    - 例：`booking_curve/forecast_simple.py` など。
  - 名称だけを見て推測で実装し直さず、**必ず既存実装を読んでから変更**してください。
  - 意味を変える場合は、テストとコメントをセットで更新してください。
- **評価ロジック（MAE, MAPE, Bias, RMSE, MPE など）**
  - 評価指標の計算方法は、`booking_curve/evaluation_multi.py` など既存の実装に揃えてください。
  - 独自の定義に差し替えたい場合は、既存の関数を壊さずに別名で追加し、
    どの画面・CSV がどの定義を使うかをコメントで明示してください。

---

## 5. コード生成・編集時の基本ルール

- **既存コードを必ず読むこと**
  - 新しい関数・クラスを追加する前に、同等の処理がないか既存モジュールを確認してください。
  - 似た名前の関数が複数ある場合、意味の違いを理解してから変更してください。
- **ダミー実装（NO-OP）禁止**
  - `pass` や「仮実装」とコメントしながら、実際には何もしない関数を増やさないでください。
  - どうしても中身が決められない場合は、例外を投げるか、  
    「未実装」であることを明確にするコメントを残してください。
- **暗黙のフォールバック禁止**
  - 例：ファイルが見つからない時に、勝手に空データで処理続行する、など。
  - エラーが起きた場合は、ログに理由を出力するか、上位に例外を渡してください。
- **関数名・引数名の変更は慎重に**
  - GUI や CLI からも呼ばれている可能性があります。  
  - 変更が必要な場合は、呼び出し元も含めて全て修正してください。
- **外部仕様を勝手に変えない**
  - CLI 引数、GUI 上の入力項目、出力CSVの列構成など、
    ユーザーが直接触る仕様は「外部仕様」として扱い、後方互換性を意識してください。

---

## 6. テストと検証に関するルール

- 既存のテストスクリプト（`test_*.py`）が存在する場合：
  - **テストが通っていない状態で「完成」「成功」と報告しないでください。**
  - テストが落ちた場合、その原因（テスト側か実装側か）をコメントで説明してください。
- 新規の重要ロジックを追加・変更する場合：
  - 可能な限り、**最小限でも良いのでテストを1本以上追加**してください。
  - テストコードの直前に、そのテストの目的を日本語コメントで書いてください。  
    例：
    ```python
    # このテストの目的：
    # ASOF より先の日付には ACT が埋まらないことを確認する。
    ```
- 「テストを書けない」と判断した場合は、その理由をコメントで明示してください。

---

## 7. ログ・コメント・ドキュメント

- コメント・docstring は **日本語で簡潔に** 書いてください。
  - 目的：将来、他メンバーやユーザーの部下が読んだときの理解を助けるためです。
- 新しい関数を追加する際は、以下を書いてください：
  - 何をする関数か（1〜2行）
  - 重要な引数の意味
  - 返り値の概要
- 仕様に迷いがあった場合：
  - 自分の判断で決めた場合は、  
    「※仕様不明のため暫定判断」といったコメントを残してください。

---

## 8. レポートや説明文を生成する際のルール

- モデル評価（bias, MPE, MAPE, RMSE など）について説明するとき：
  - 一般論だけでなく、**このリポジトリで使っている定義・計算式**にも触れてください。
  - どの CSV / 関数 / ファイルに対応するかを必ず示してください。
    - 例：「`booking_curve/evaluation_multi.py` の `calc_mape` 相当の処理を参照」など。
- README やドキュメントを生成するとき：
  - rm-booking-curve-lab の具体的なファイル・スクリプト名をできる限り紐づけて説明してください。
  - 抽象的な「AI とは」「ブッキングカーブとは」の説明だけで終わらないでください。

---

## 9. Codex 用プロンプトを生成する際のルール

- Codex など「コードを書き換えるエージェント」に渡すプロンプトを生成する場合：
  - **Pythonコメントだけで構成されたコードブロック** を使ってください（すべて `#` から始める）。
  - 次の順番で情報を書いてください：
    1. 役割宣言  
       - 例：`# あなたは既存コードをリファクタリングするPythonエンジニアです。`
    2. 対象ファイルのパス  
       - 例：`# 対象ファイル: booking_curve/lt_builder.py`
    3. 目的（高レベル）  
       - 例：`# 目的: LT_DATA CSV の生成ロジックを整理し、バグ修正と可読性向上を行う。`
    4. 前提・制約（変えてはいけない外部仕様など）
    5. 具体的な修正内容（番号つき箇条書き）
    6. 出力の指示  
       - 例：`# 修正後のファイル全体を出力してください。`  
             `# 既存のコメントやdocstringは可能な限り保持してください。`  
             `# 余計な説明文は出力せず、Pythonコードのみを出力してください。`
  - 原則として、Codex には **修正後のファイル全体** を出させ、
    ユーザーがそのまま置き換えられる形にしてください。

---

## 10. 禁止事項まとめ

AI エージェントは、以下のことを **してはいけません**：

1. 既存の仕様を読まずに、モデルロジック（avg / recent90 / recent90w など）を勝手に再定義すること。
2. テストが落ちている状態を放置したまま、「実装完了」と扱うこと。
3. ASOF や ACT の扱いを誤解したまま、グラフや予測のロジックを変更すること。
4. GUI フレームワークを Tkinter 以外に変更すること。
5. 何もしないダミー関数・クラスを増やすこと。
6. ファイルパスや設定値を、ユーザーの環境に依存する形でベタ書きすること。
7. 標準CSVや LT_DATA CSV の列構成・意味を、理由なく変更すること。
8. Codex 用プロンプトのフォーマットを独自に変え、再利用性を下げること。

---

以上のルールを守ったうえで、rm-booking-curve-lab の品質と一貫性を維持しつつ、
コード生成・修正を行ってください。