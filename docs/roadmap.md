# rm-booking-curve-lab ロードマップ（2025-12 時点）

## 0. 現在地（v0.6.6 相当）

### 完了していること

- **月次ブッキングカーブ**
  - v0.6.3 にて、時系列 OH から直接集計するロジックに刷新済み。
  - v0.6.5 相当以降、daily snapshots ルートでも同等の monthly_curve を生成可能（数値一致確認済み）。

- **標準日別スナップショットレイヤー（daily snapshots）**
  - `daily_snapshots_<hotel_id>.csv` を「唯一の正」とするためのインフラを整備。
  - N@FACE の複数パターンを `pms_adapter_nface.py` で吸収し、標準CSVへ正規化できる。

- **LT_DATA のソース切替（timeseries / daily_snapshots）**
  - daily snapshots から LT_DATA を生成するルートを追加し、旧ルートと共存可能。

- **欠損値（NaN）補完ポリシーの整理**
  - データレイヤーは生の NaN を保持。
  - ビュー/評価レイヤーで LT方向の補完（LOCF）を適用して表示を滑らかにする。

- **GUI運用導線の強化**
  - GUI から LT_DATA（直近4ヶ月 / 期間指定）を生成可能。
  - `daily_snapshots` をソースにした場合のみ、LT生成時に snapshots 更新を任意で実行可能。
  - `timeseries` 選択時は更新オプションを無効化（無駄な処理時間を発生させない）。

### 旧仕様のまま残っている部分

- daily snapshots の再生成が「全量前提」になりやすく、データ量増加で処理が重くなる懸念。
- ADR / 売上の本格予測は未実装（Rooms中心）。

---

## 1. 次のフェーズ：daily snapshots の部分生成（Partial build / Upsert）

**ブランチ：`feature/daily-snapshots-partial-build`**

### 1-1. 目的
- 初期投入（過去2〜3年の全量生成）後、週次運用では「必要な範囲だけ」更新できるようにして、
  処理時間を現実的に保つ。

### 1-2. 方針
- Full rebuild：初期/整合性取り直し用途
- Partial build：日常運用用途
  - 例：当月〜翌3ヶ月に影響する as_of_date 範囲（直近N日）だけを upsert 更新
  - upsert は `(hotel_id, as_of_date, stay_date)` キーで last-wins

### 1-3. 実装タスク（概要）
- `daily_snapshots.py` に partial build API を追加（読み込み→範囲削除→再生成→dedupe→保存）
- CLI と GUI の両方から同じAPIを叩ける形に統一
- 検証：full と partial で LT_DATA / monthly_curve が一致すること（対象範囲内）

---

## 2. フェーズ2：日別売上予測（ADRモデル＋ハイブリッド）

**目的：** 副業で使えるレベルの **日別売上予測（Revenue Forecast）** を実装する。

### 2-1. コア方針

- 稼働率（Rooms部分）は、現行の LT ベースモデル群（`avg`, `recent90`, `recent90w`, `recent90_adj` 等）を継続利用。
- 売上予測は **「稼働率 × ADRモデル」** で構成する。
- ADRモデルは、以下の多層構造を想定：

  1. **ベースラインADR**
     - 過去数年の中から「波形が近い年」または直近数年平均を使用。
     - `year × month × weekday` 単位のベースラインADRを作成。
  2. **インフレ調整**
     - 直近3〜6ヶ月の ADR トレンド（前月比・前年同月比）からインフレ率を推定。
     - ベースラインADRに係数をかけて「今年の水準 ADR」に補正。
  3. **短期トレンド調整（ミクロ）**
     - 直近1〜2週間の ADR / RevPAR の動きから、  
       「今はベースラインより上振れ/下振れしているか」を判断し、係数で微調整。
  4. **RevPARマクロとのハイブリッドチェック**
     - 月別 RevPARのフロー（前年比の伸び方・波形）と乖離しすぎていないかをチェック。
     - 明らかに不自然なケースでは、極端なADR予測を抑制する。

### 2-2. 実装タスク

1. daily_snapshots から ADR / RevPAR 時系列を生成
   - 各 `stay_date` について：
     - `rooms_oh` / `revenue_oh` から ADR を算出。
     - 稼働率と組み合わせて RevPAR を算出。

2. ベースラインADRテーブル作成
   - `year × month × weekday` の ADR を集計。
   - 使用年の選択ロジック：
     - 初期実装：直近2〜3年平均。
     - 余裕が出たら：「RevPARフローが似ている年」を選ぶロジックに拡張。

3. インフレ率推定と適用
   - 直近3〜6ヶ月の ADR 前月比・前年同月比からシンプルな係数を推定。
   - ベースラインADRに掛けて、当該年の期待ADRに調整。

4. 短期トレンド調整
   - 直近1〜2週間の移動平均ADR vs ベースラインADRの差を元に、±αの補正。

5. 売上予測への落とし込み
   - 稼働率予測 × ADRモデル → 日別売上予測。
   - まずは月次合計レベルで実務感覚とズレていないかを検証。

---

## 3. フェーズ3：ペース比較＋料金レコメンド（Decision Support）

**目的：**  
日別売上予測とブッキングカーブを使って、**具体的な「打ち手」まで落とすエンジン**を作る。

### 3-1. 仕様の方向性

- 比較対象（ベンチマークASOF）の候補：
  - モデル評価タブで用いている固定ベンチマーク：
    - `M-2_END` / `M-1_END`
  - または「常に1週間前のASOF」との比較（直近動向に敏感）。
- ペースの基本概念：
  - ある 1週間の間に「予約残がどの程度減ったか」を見る（net pickup）。
  - 鈍い場合：
    - 取消が多い
    - ピックアップが弱い
    - その複合
  - 団体の大口キャンセルなどの外れ値は、ペース評価から除外する。

### 3-2. 実装ステップ

1. ペース差分指標の設計
   - 例：  
     - 「直近1週間の net pickup vs ベンチマーク週」の差分を  
       稼働率・売上ベースで数値化。

2. レートアクションのルール化
   - シンプルなルールから開始：
     - 例：
       - ペースが基準比 +X%以上 → 「ADRを Y%まで上げても許容」といったゾーン表示。
       - ペースが基準比 -X%以上 → 「ADRを Z%引き下げを検討」ゾーン。
   - 初期は「インジケータ＋レコメンド文」のみに留め、  
     実際の金額決定はユーザーに委ねる。

3. GUIへの反映（将来タスク）
   - ブッキングカーブタブまたは日別FCタブに  
     「ペース評価＋レコメンド」の表示枠を追加。

---

## 4. フェーズ4：評価ロジックのアップデート（バイアス補正＋日別評価）

**目的：**  
「どのモデルが使えるのか」「どこまで攻めて良いか」を、  
より定量的に説明できる状態にする。

### 4-1. 月別誤差のクセ補正（重要）

- 現状：
  - 日別FCの基準値にバイアス補正済み値を使っているが、  
    実装としてはまだ「ローカル仕様」に近い。
- 方針：
  - 直近12ヶ月程度の「月次誤差（バイアス or MPE）」を集計。
  - 月別に「+3% 出がち」「-2% 守りがち」などの傾向を一覧化。
  - 将来予測の基準値への反映（ON/OFF可能なオプションも検討）。

### 4-2. 日別評価への拡張（優先度：中〜高）

- 現状：
  - 評価は「月次合計ベース」が中心。
- 目指す方向：
  - 日別誤差に基づいた評価指標（MAPE, RMSE 等）も導入し、
    - 「月次では良いが、日別だと荒いモデル」
    - 「月次はそこそこだが、日別は安定しているモデル」
    を識別できるようにする。
- 注意点：
  - 説明負荷が上がるため、フェーズ3がある程度回り始めてから着手するほうが現実的。

---

## 5. フェーズ5：周辺機能（優先度：中）

### 5-1. 会議用資料の自動出力（PPTX / 画像）

- 月次ブッキングカーブ＋サマリー（RevPAR / MAPE / バイアスなど）を  
  PowerPoint または PNG で自動生成。
- 将来的には、副業での「診断レポート」の型と直結させる。

### 5-2. recent90w ウェイトのマスタ設定

- マスタ設定タブ or 設定ファイル（JSON）で recent90w 系ウェイトを定義。
- 与件：
  - クライアント側が勝手に触りすぎるリスクもあるため、
    - マスタタブに「ロック」機能
    - もしくは開発者側で JSON による管理
    を検討。
- 将来的には「最適モデルの自動選択」にもつなげる。

### 5-3. カレンダー生成の自動化

- ASOFレンジやLTレンジに応じた評価期間・予測期間カレンダーを自動生成。
- 毎回、人手で期間設定を行わなくても良い構造にする。

---

## 6. フェーズ6：副業ビジネスへのブリッジ

**目標：**  
このツール群を、「ホテル向けレベニューマネジメント／OTA運用支援」の  
**コンサルサービスを支えるエンジン**として活用する。

### 6-1. 顧客に約束すること

- 今どこにボトルネックを抱えているかの診断。
- どういう理屈でレート調整をすべきかの理解と、オペレーション改善。
- 「状況が良いか悪いか」「どこまで攻められるか」を確認しつつ、  
  レート調整〜フォーキャストまで一気通貫で見通せるツール＋運用支援。

### 6-2. あくまで“目安”として位置づけるもの

- 売上予測の「絶対値」そのもの：
  - 実務では、「どの程度攻め／守りか」「想定レンジの中にいるか」を説明するための材料として扱う。
  - 予測値＝約束値ではなく、「意思決定を支える目安」として使う。

---
