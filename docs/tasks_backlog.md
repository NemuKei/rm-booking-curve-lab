# Tasks Backlog

本ファイルは BookingCurveLab プロジェクトのタスク一覧（バックログ）です。  
フェーズ別に `P<phase>-<連番>` のIDを付与し、GitHub Issues などと同期して管理することを想定しています。

- `[ ]` … 未着手
- `[~]` … 着手中
- `[x]` … 完了（Issue Close 済みなど）

---

## Phase 1: LT from daily snapshots への移行

### 目的
- LT_DATA を daily snapshots ベースに統一し、
  「PMS 生データ → daily_snapshots → LT_DATA → 月次/日次ブッキングカーブ」の一貫パイプラインを完成させる。

### タスク

- [ ] **P1-01** `lt_builder.py` に `build_lt_data_from_daily_snapshots_for_month(...)` を追加する  
  - 引数：`hotel_id` / `target_month(YYYY-MM)` / `max_lt` など  
  - 入力：`daily_snapshots_<hotel>.csv` から対象月の `stay_date` を抽出  
  - 出力：既存 LT_DATA CSV と互換性のある `DataFrame`（`stay_date`×`lt`）を返す

- [ ] **P1-02** daily snapshots 読み出し用のヘルパー関数を実装する  
  - 場所：`daily_snapshots.py` もしくは新規モジュール  
  - 用途：`hotel_id` / `target_month` から対象範囲の `daily_snapshots` を取得する共通関数

- [ ] **P1-03** `run_build_lt_csv.py` に `source` パラメータを追加する  
  - `"timeseries"` / `"daily_snapshots"` を指定可能にする  
  - デフォルトは互換性維持のため `"timeseries"` とする  
  - CLI 引数または設定ファイルで切り替えられるようにする

- [ ] **P1-04** 旧LTルートとの比較スクリプトを追加する  
  - 例：`compare_lt_from_timeseries_vs_snapshots.py`  
  - 入力：旧LT_DATA CSV、新LT_DATA CSV  
  - 出力：
    - `LT×stay_date` ごとの差分統計（平均・最大・件数）  
    - 大きくズレているセルの一覧CSV

- [ ] **P1-05** 実データでの比較検証を行う  
  - 対象：1〜2ヶ月分 × 複数ホテル  
  - 手順：
    - 旧ルート・新ルート双方で LT_DATA を生成  
    - 差分スクリプトで比較  
    - 実務上許容できるかどうかをコメントにまとめる

- [ ] **P1-06** 差分検証結果を仕様に反映する  
  - `spec_data_layer.md` に「timeseries ルートと snapshots ルートの差分・注意点」を追記  
  - 必要に応じて `spec_models.md` にも前提を追加

- [ ] **P1-07** 将来的なデフォルト切り替えのフラグを設計する  
  - 設定ファイル（JSON 等）に `lt_source_default` のようなキーを追加  
  - 実際の切替は Phase2 以降でもよいが、設計だけ先に決めておく

---

## Phase 2: Daily Revenue Forecast（ADRモデル＋ハイブリッド）

### 目的
- OCC 予測（室数）に ADR モデルを掛け合わせ、日別売上予測（Revenue Forecast）を出せるようにする。
- 副業での「診断レポート／助言」の武器にする。

### タスク

- [ ] **P2-01** `daily_snapshots` から ADR / RevPAR 時系列を生成する機能を追加  
  - 入力：`daily_snapshots_<hotel>.csv`  
  - 出力：`stay_date` ごとの `rooms_oh` / `revenue_oh` / `occ` / `adr` / `revpar` を持つ `DataFrame`  
  - 仕様は `spec_data_layer.md` に追記済の内容と整合させる

- [ ] **P2-02** ベースラインADRテーブル生成ロジックを実装する  
  - 集計単位：`year × month × weekday`  
  - ベースライン：直近2〜3年の平均（初期実装）  
  - 将来の「類似年選択」に備えて、インターフェイスは拡張しやすい形にしておく

- [ ] **P2-03** インフレ調整ロジックを実装する  
  - 直近3〜6ヶ月の ADR 実績から「今年の水準へのスケール係数」を推定  
  - ベースラインADRに掛けて「今年の期待水準ADR」を算出

- [ ] **P2-04** 短期トレンド調整ロジックを実装する  
  - 直近7〜14日間の ADR / RevPAR の移動平均と、ベースラインとの差を算出  
  - 過度な振れ幅にならないようクリッピング処理を含める

- [ ] **P2-05** RevPARマクロとの整合チェック処理を実装する  
  - 月別RevPAR フロー（前年対比など）と、日別売上予測の合計を比較  
  - 明らかに高すぎ／低すぎる場合の補正係数ロジックを設計

- [ ] **P2-06** OCC予測とADRモデルを組み合わせる関数を実装する  
  - 引数：OCC予測（`rooms_forecast`）と ADR モデルの予測値  
  - 出力：日別売上予測 `revenue_forecast`  
  - 月次・日次の評価用データへの書き込みも行う

- [ ] **P2-07** 評価タブに売上指標を追加する  
  - 月次評価に「売上ベースの MAPE / バイアス」などを追加  
  - GUI の表示変更が必要な場合は `spec_evaluation.md` にも反映

- [ ] **P2-08** `spec_models.md` に ADRモデルの確定仕様を反映する  
  - ベースライン／インフレ／短期トレンド／マクロ調整の実装内容を更新  
  - 「案」から「実装仕様」に格上げする

---

## Phase 3: ペース比較＋料金レコメンド（Decision Support）

### 目的
- ペース（net pickup）の良し悪しを定量化し、
  「レートを上げても良い／下げるべき」の判断材料を提示する。

### タスク

- [ ] **P3-01** ベンチマークASOFの選択ロジックを設計する  
  - 候補：`M-2_END` / `M-1_END` / 「1週間前のASOF」など  
  - 評価タブのASOFと整合が取れる仕様にする

- [ ] **P3-02** ペース指標（net pickup）の定義と計算ロジックを実装する  
  - 期間例：直近7日間の `net pickup`（予約−取消）  
  - 指標例：稼働率ベース／売上ベースの両方を検討

- [ ] **P3-03** 外れ値（大口キャンセル等）の除外ロジックを設計・実装  
  - 一定室数以上のキャンセルを「特異イベント」とみなす  
  - ペース評価に含める／含めない条件を明文化し、`spec_evaluation.md` に追記

- [ ] **P3-04** レートアクションのルールベースロジックを実装する  
  - 例：
    - ペースが基準より +X% 以上 → ADR を Y% まで上げてもよいゾーン  
    - ペースが基準より −X% 以上 → ADR を Z% まで下げる推奨  
  - 初期実装は if文ベースの単純ルールで良い

- [ ] **P3-05** レコメンド出力フォーマットを設計する  
  - 出力例：
    - 「ペース良好：+15%。来週末はADR+1,000円まで許容」  
    - 「ペース弱い：-10%。平日の連泊プラン割引を検討」  
  - GUI or CSV 出力として、人間が読める形で出す

- [ ] **P3-06** GUIへの組み込み（将来）  
  - ブッキングカーブタブ、もしくは日別FCタブに「ペース評価＋レコメンド」の表示枠を追加  
  - 表示に必要な追加項目があれば `spec_overview.md` / `spec_models.md` を更新

---

## Phase 4: 評価ロジックのアップデート（バイアス補正＋日別評価）

### 目的
- 「どのモデルが使えるか」「どこまで攻めて良いか」を、
  月次だけでなく日次の誤差も含めて説明できるようにする。

### タスク

- [ ] **P4-01** 月別バイアスの集計・可視化ロジックを実装する  
  - 直近12ヶ月程度の月次バイアス（MPE）を算出  
  - 「+3%出がち」「−2%守りがち」などのクセを一覧化

- [ ] **P4-02** バイアス補正を基準値に反映する仕組みを設計  
  - 基準シナリオ（基準値）に月別のバイアスを加味するかどうかを選択可能にする  
  - 評価タブや設定で ON/OFF できるようにする

- [ ] **P4-03** 日別評価指標（MAPE, RMSE 等）を追加する  
  - `evaluation_daily_errors.csv` の仕様を確定  
  - モデル別・日別での誤差を可視化できるようにする

- [ ] **P4-04** `spec_evaluation.md` に日別評価の仕様を追記  
  - 月次・日次それぞれにどの指標を使うか  
  - 「月次では良いが日次では荒いモデル」などの典型パターンを想定しておく

- [ ] **P4-05** GUI側に日別評価のサマリを表示する  
  - 例：評価タブに「日別MAPEの箱ひげ」や簡易統計を追加  
  - UIの変更があれば `BookingCurveLab_README.txt` も更新

---

## Phase 5: 周辺機能（報告書・ウェイトマスタ・カレンダー）

### 目的
- ツールを「現場で使い倒せる」状態にし、副業での再利用もしやすくする。

### タスク

- [ ] **P5-01** 会議用資料（PPTX/画像）自動出力のテンプレートを設計  
  - 月次ブッキングカーブ＋RevPARサマリ＋MAPE/バイアスを1枚〜数枚にまとめる  
  - フォーマット案を `docs/` にサンプルとして保存

- [ ] **P5-02** PowerPoint 自動出力スクリプトを追加  
  - matplotlib で生成したグラフを画像化 → PPTXに貼り付け  
  - 副業用の「診断レポートひな形」との兼用を想定

- [ ] **P5-03** `recent90w` ウェイトマスタの設計  
  - 設定ファイル（JSON等）にウェイトパターンを定義  
  - ホテル別、シナリオ別に切り替え可能な構造にする

- [ ] **P5-04** `recent90w` ウェイトの読み込み／適用ロジックを実装  
  - `forecast_simple.py` で設定値を読み込み  
  - 評価タブからパターンを選べるようなUI設計も検討

- [ ] **P5-05** 評価用カレンダー生成の自動化  
  - LTレンジ・ASOFレンジに応じた「評価期間カレンダー」を自動生成  
  - 人手での期間設定を最小限にする

---

## Phase 6: 副業ビジネスへのブリッジ

### 目的
- BookingCurveLab の機能群を活かし、  
  「診断レポート＋運用支援」という副業パッケージに落とし込む。

### タスク

- [ ] **P6-01** 副業パッケージの提供価値を整理する  
  - 約束すること（ボトルネック診断／レート戦略の理屈／運用改善支援）  
  - あくまで目安とするもの（売上予測の絶対値）を文章化

- [ ] **P6-02** 診断レポートの標準フォーマットを設計する  
  - 1ホテル用のA4数枚程度のテンプレ  
  - BookingCurveLab の出力（グラフ／指標）をどこに配置するかを決める

- [ ] **P6-03** 診断レポート自動生成との連携仕様を検討  
  - Phase5 で作成した PPTX ひな形との連携  
  - Pythonスクリプトでの自動生成フローを設計

- [ ] **P6-04** 導入〜運用の「サービスフロー」を文書化  
  - 初回ヒアリング → データ受領 → モデル構築 → 診断レポート → 定期フォロー  
  - 料金レンジやスコープも仮決めしておく

- [ ] **P6-05** Webサイト／提案資料向けの説明文を準備  
  - 「何ができるツールか」「どこまで約束するか」を、非エンジニア向けに整理  
  - 将来的にLPや営業資料に転用する前提で書く

---
