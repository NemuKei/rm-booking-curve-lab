Proposed file path: docs/thread_logs/2026-01-23_1527_main_samp_main.md

# Thread Log: 2026-01-23_1527_main_samp_main

## Meta

* Date: 2026-01-23
* Branch: main
* Scope: samp_main
* Source of truth (ZIP): rm-booking-curve-lab_20260123_1524_samp_main_2e5b3ac_full.zip
* Commit: 2e5b3ac
* Outcome: Released (GitHub Releases)

## Summary

TopDownRevPAR が日別Forecastの状態を汚染して数値が壊れる（予測OCCが一律化する等）事象を解消し、TopDown診断テーブルに根拠列を追加して検証可能性を強化。併せて、ブッキングカーブタブの LT_DATA 更新でUIが固まり続ける問題を、準備フェーズ分離＋進捗表示で回避。Daily snapshots 全量再生成の案内メッセージ（概算時間表示）も現実的な形に調整し、mainをリリース。

## Work items

* U-004: recent90×カレンダーCSV欠損で落ちる件／3月Forecast実行で落ちる件（gui_app.log例外）

  * 状態: 前段で修正済み前提。今回スレッドではコード健全性観点の確認対象。
* U-005〜U-010: TopDownRevPAR の FcRevPAR が月次サマリと一致しない／差異が大きい

  * 状態: 原因が「丸め」レベルではなく、状態汚染を疑う流れへ。
  * 施策: TopDown下部の診断テーブルに根拠列（FcADR/FcOcc%/FcRooms/FcRev/cap/days 等）を追加して、前提一致を可視化。
  * 結果: 正常値一致を確認（改善確認済のスクショ状態）。
* U-008〜U-009: TopDownRevPARを開いた後に日別Forecastが壊れる（予測OCCが一律 38.7% 等）

  * 状態: TopDown表示がトリガーで共有状態が上書きされる挙動を確認。
  * 結果: 修正後は再現しない（正常挙動を確認）。
* U-011〜U-012: ブッキングカーブタブ LT_DATA 更新フリーズ回避

  * 状態: 初期は固まるが途中から軽くなる挙動 → 進捗UI導入でフリーズ回避を確認。
  * 結果: 「LT_DATA準備中」画面表示で回避確認済。
* Daily snapshots 全量再生成メッセージ（概算時間）

  * 状態: 乖離が大きい指摘。
  * 結果: 修正確認済。

## Key decisions (thread-scoped)

* 丸め後までの一致は必須要件としない一方で、丸め前の「モデル/ASOF/根拠/予測値」は一致させる検証軸で進行。
* TopDownRevPAR診断テーブルに根拠列を追加し、原因切り分けを可能にする（実装価値ありとして採用）。
* bADR/bOcc は FcADR/FcOcc% と同値になったため、UI上は冗長（次回整理で非表示化してよい合意）。

## Artifacts / files touched (high level)

* TopDownRevPAR・予測連携（状態汚染回避／診断列追加）

  * src/booking_curve/gui_backend.py
  * src/gui_main.py
* LT_DATA 更新フリーズ回避（準備処理分離・進捗UI）

  * src/gui_main.py
* Daily snapshots 全量再生成メッセージ見直し

  * src/gui_main.py
* Release ZIP

  * rm-booking-curve-lab_20260123_1524_samp_main_2e5b3ac_full.zip

## Next thread

* pace14_market の market補正を線形→power に修正検討
* 同時に clip が安全寄りすぎる点を調整
* まずはブランチ作成から開始

---