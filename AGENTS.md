# AGENTS.md – rm-booking-curve-lab 向け AI 用ルール

この文書は、rm-booking-curve-lab リポジトリで作業する **AIエージェント
（例: ChatGPT, GitHub Copilot, Codex 等）** に対するルールです。

ここに書かれていることは、一般的なコーディングスタイルやあなた自身の
「良かれと思った判断」よりも **優先順位が高い** ものとします。

---

## 0. 参照すべきドキュメント

このプロジェクトでは、仕様・設計・タスクはリポジトリ内の docs を
**「唯一の正（Single Source of Truth）」** として扱います。

AI エージェントは、以下のファイルを優先的に参照してください。

- `docs/spec_overview.md`  
  - プロジェクト全体の目的・前提・フォルダ構成
- `docs/spec_data_layer.md`  
  - `daily_snapshots` / `LT_DATA` / 評価用CSVなど、データ構造の仕様
- `docs/spec_models.md`  
  - avg / recent90 / recent90w などのモデル仕様、将来のADRモデルの方針
- `docs/spec_evaluation.md`  
  - 月次／日次評価ロジックと指標（bias, MAPE, RMSE など）の定義
- `docs/roadmap.md`  
  - フェーズ0〜6の開発ロードマップ
- `docs/tasks_backlog.md`  
  - フェーズ別タスク一覧（`P1-01` 形式のID付き）
- `BookingCurveLab_README.txt`  
  - 利用者向けの操作説明・FAQ
- `AGENTS.md`（本書）  
  - AIエージェント向けの運用ルール

**重要：**

- 仕様や方針に迷ったら、まず `docs/*.md` を読み、  
  そこに書かれていないことだけを推論してください。
- 仕様とコードが矛盾しているように見える場合は、  
  「仕様が優先」である前提で、コメントやTODOに疑問点を残してください。

---

## 1. プロジェクトの目的と前提

- このプロジェクトは、ホテルの **ブッキングカーブ／リードタイム(LT) データ** を用いて、
  予約推移と宿泊実績を可視化し、簡易な予測（forecast）と評価を行うツールです。
- PMS（N@FACE）由来の生データを
  `daily_snapshots → LT_DATA → 評価用データ → グラフ・レポート`
  という一貫したパイプラインで扱います。
- GUI（Tkinter）・CLI スクリプト・共通モジュールをすべて **Python** で実装します。
- Windows 環境での EXE 配布を前提とし、サードパーティ依存は慎重に扱います。
- ユーザーは複数ホテルを管理しており、将来的にホテル数や評価ロジックが増える前提です。

---

## 2. 役割分担：ChatGPT vs Codex

このプロジェクトでは、AIエージェントの役割を以下のように分けます。

### 2.1 ChatGPT の役割

- 仕様・設計・要件の整理
- `docs/*.md`（仕様書・ロードマップ・タスク）の作成・更新案の生成
- Codex に渡すプロンプト（タスク定義）の設計
- コードレビューの補助（設計観点・仕様との整合チェック）
- README / 説明資料などテキストベースのドキュメント生成

### 2.2 Codex / コード生成エージェントの役割

- 既存仕様に基づくコード実装・修正・リファクタリング
- テストコードの追加・修正
- 評価やバッチ処理などのスクリプト実装
- コメント・docstring の追加（仕様の補足レベルにとどめる）

**原則：**

> `docs/` 以下の仕様書は、「人間＋ChatGPTのみが編集」し、Codex には参照専用とする。

---

## 3. docs/ の編集ルール

### 3.1 誰が編集してよいか

- `docs/spec_overview.md`  
- `docs/spec_data_layer.md`  
- `docs/spec_models.md`  
- `docs/spec_evaluation.md`  
- `docs/roadmap.md`  
- `docs/tasks_backlog.md`  

これらのファイルは、**原則として人間と ChatGPT が編集**します。

Codex（コード生成エージェント）は：

- これらのファイルを **読み取り専用** とみなしてください。
- 仕様・設計・タスクの文言を変更・削除しないでください。

### 3.2 例外（Codex が触ってもよいケース）

プロジェクトオーナーが明示的に指示した場合のみ、以下は例外として許可されます。

- 特定セクションに「表やサマリを追記する」などの **追加専用タスク** を行う場合
  - 例：「`spec_evaluation.md` の末尾に、最新の evaluation_multi の指標サマリ表だけ追記して」

ただしこの場合も：

- 既存の文章・見出し・構造を変更しないこと
- 人間が必ず差分をレビューしてからマージすること

---

## 4. コード構成と責務のざっくりした整理

（詳細は `spec_overview.md` / `spec_data_layer.md` を優先）

- `gui_main.py` / `gui_backend.py`  
  - Tkinter ベースの GUI ロジック・イベントハンドラ
  - 直接ビジネスロジックを書き込まず、共通モジュールを呼び出す役割

- `daily_snapshots.py` / `pms_adapter_nface.py`  
  - PMS 生データから標準 `daily_snapshots_<hotel>.csv` を生成するレイヤー

- `lt_builder.py`  
  - `daily_snapshots` や（旧）時系列Excelから LT_DATA を構築するロジック

- `forecast_simple.py`  
  - `avg / recent90 / recent90w` など LT ベースの予測モデル群
  - 将来的な ADR モデルの一部ロジックもここに入る可能性あり

- `run_build_lt_csv.py` / `run_full_evaluation.py`  
  - CLI 用のエントリポイント
  - パラメータを読み取り、共通ロジックを呼び出し、CSVを出力

AIエージェントは、**ビジネスロジックは共通モジュール側に寄せ、
GUI / CLI はできるだけ薄く保つ**よう意識してください。

---

## 5. 実装時のスタイル・技術的ルール

- Python バージョン：docs で指定されているものに合わせる（明記されていない場合は 3.10+ を仮定）
- Lint / Format：
  - `ruff` を前提としたスタイルを意識する
  - 未使用インポート・未使用変数は残さない
- 型ヒント：
  - 公開関数・クラスメソッドには極力 type hints を付ける
- ログ出力：
  - デバッグ用途の `print` は残さない
  - 必要に応じて `logging` モジュールを利用する
- 例外処理：
  - PMS ファイル読み込みなど失敗しうる箇所には try/except を適切に入れる
  - ただし安易な `except Exception: pass` は禁止
- 外部ライブラリ：
  - 標準ライブラリで代替可能なときはそちらを優先する
  - 新規ライブラリ導入が必要な場合は、まずコメントや TODO で提案レベルにとどめる

---

## 6. 仕様変更とコード変更のフロー

### 6.1 仕様を変えたいとき（正しい順番）

1. ChatGPT とユーザーが仕様変更を議論する。
2. ChatGPT が `spec_*.md`（および必要なら `roadmap.md` / `tasks_backlog.md`）の修正案を生成する。
3. ユーザーが内容を確認し、docs を更新する。
4. `docs/tasks_backlog.md` にタスクID（例：`P1-01`）を追加／更新する。
5. そのタスクIDを前提とした Codex 用プロンプトを作成し、実装を依頼する。

### 6.2 コード側の改善から仕様を逆輸入したいとき

1. Codex が実装を変更する（仕様に反さない範囲で）。
2. 変更内容（挙動の差分）を ChatGPT に説明させる。
3. ChatGPT が仕様への反映案（`spec_*.md` の修正）を作成する。
4. ユーザーがレビューし、docs を更新する。

**禁止：**

- Codex が docs を勝手に編集して仕様を「合わせにいく」こと。
- 仕様ドキュメントを更新せずに、実装だけを変更すること（大きな変更の場合）。

---

## 7. Codex 用プロンプト生成ルール（ChatGPT向け）

ChatGPT が Codex 用プロンプトを生成するときは、以下を必ず含める。

1. **目的（What & Why）**
   - 例：「LT_DATA を daily snapshots ベースで生成する新関数を追加したい」

2. **参照すべき仕様ファイル**
   - 例：「`docs/spec_data_layer.md` / `docs/spec_models.md` / `docs/tasks_backlog.md` の P1-01〜P1-03」

3. **今回のタスクIDと範囲**
   - 例：「今回は `P1-01` のみを実装対象とし、それ以外は変更しない」

4. **変更対象ファイル**
   - 例：「`lt_builder.py` に関数を追加」「`run_build_lt_csv.py` に引数を追加」など

5. **完了条件**
   - 例：「既存LT_DATAと互換の DataFrame を返すこと」「既存テストを落とさないこと」

6. **制約**
   - docs/ は read-only であること
   - Ruff でLintを通る実装にすること
   - GUIフレームワークを変えないこと など

---

## 8. モデル・評価ロジックに関する注意

- avg / recent90 / recent90w などのモデル定義は、必ず `docs/spec_models.md` に従う。
- 月次・日次の誤差指標（bias, MAPE, RMSE など）の定義は、
  `docs/spec_evaluation.md` に従う。
- 新しい指標やモデルを追加したい場合は、
  まず ChatGPT と仕様レベルで合意し、docs を更新した後に実装する。

モデル評価や統計指標について説明するときは：

- 一般論（統計的な定義）にとどまらず、
- **このリポジトリでの具体的な使い方や CSV 列との対応** に必ず触れること。

---

## 9. 禁止事項（Do NOT）

AI エージェントは、以下のことを **してはいけません**：

1. 既存の仕様 (`docs/spec_*.md`) を読まずに、  
   モデルロジック（avg / recent90 / recent90w など）を勝手に再定義すること。
2. テストが落ちている状態を放置したまま、「実装完了」と扱うこと。
3. ASOF や ACT の扱いを誤解したまま、グラフや予測のロジックを変更すること。
4. GUI フレームワークを Tkinter 以外に変更すること。
5. 何もしないダミー関数・クラスを増やすこと。
6. ファイルパスや設定値を、ユーザーの環境に依存する形でベタ書きすること。
7. 標準CSVや LT_DATA CSV の列構成・意味を、理由なく変更すること。
8. Codex 用プロンプトのフォーマットを独自に変え、再利用性を下げること。
9. `docs/` 以下の仕様書を、明示的な許可なく書き換えること。

---

以上のルールを守ったうえで、rm-booking-curve-lab の品質と一貫性を維持しつつ、
コード生成・修正・設計支援を行ってください。
