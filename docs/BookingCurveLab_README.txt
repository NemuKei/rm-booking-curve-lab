BookingCurveLab 取扱説明書（README）

1. アプリ概要
--------------------

BookingCurveLab は、PMS の時系列オンハンドデータをもとに

- 日別・月次ブッキングカーブの可視化
- 複数モデルによるフォーキャスト
- モデルごとの誤差評価（MAE / MAPE / バイアス / RMSE など）
- 悲観 / 基準 / 楽観シナリオの算出

を GUI だけで操作できるようにしたツールです。

現在は、ホテル毎に

- lt_data_YYYYMM_<hotel>.csv（LTデータ）
- monthly_curve_YYYYMM_<hotel>.csv（月次カーブ用データ）
- evaluation_<hotel>_*.csv（モデル評価結果）

などを自動生成し、レベニューマネジメントの定例確認に使うことを想定しています。


2. 動作環境
--------------------

- OS：Windows 10 / 11
- 必要なソフト：
  - 通常利用者：特になし（Python 不要）
  - 管理者（開発者）：Python 3.11 + 必要ライブラリ（開発用）

起動方法：

1. BookingCurveLab フォルダ一式をローカル（デスクトップなど）にコピーする
   - 共有フォルダ（Box 等）から直接起動すると、セキュリティや権限の都合で動かない場合があります。
2. フォルダ内の BookingCurveLab.exe をダブルクリックして起動

初回起動時は、Windows Defender SmartScreen が警告を出すことがあります。
その場合は「詳細情報」→「実行」を選択してください（社内配布の EXE のみ）。


3. フォルダ構成
--------------------

※ 一般ユーザーが触るのは太字の部分だけを想定しています。

【実行ファイル配置（任意の場所）】
BookingCurveLab/
├─ BookingCurveLab.exe       … アプリ本体（これを起動）
└─ _internal/                 … EXE 用ライブラリ（触らない）

【端末ローカルの作業フォルダ】
%LOCALAPPDATA%/BookingCurveLab/
├─ config/
│   └─ hotels.json           … ホテル設定ファイル（管理者が編集）
├─ output/
│   ├─ lt_data_YYYYMM_<hotel>.csv
│   ├─ monthly_curve_YYYYMM_<hotel>.csv
│   ├─ forecast_*.csv
│   ├─ evaluation_*.csv
│   └─ logs/                 … 実行ログ
├─ acks/
│   └─ missing_ack_<hotel>_ops.csv
└─ local_overrides/
    └─ local_overrides.json  … RAW取込元のローカル上書き

- config/hotels.json
  - ホテルごとの表示名、デフォルトの「予測キャップ」「稼働率キャパ」などをまとめた設定ファイル。
- output/
  - アプリが自動生成する各種 CSV の置き場。基本的に手動編集は不要（分析用途で読み込むのは OK）。
- acks/
  - 欠損検査（ops）の ACK（確認済み）を端末ローカルに保持するフォルダ。
- local_overrides/
  - このPCのみ有効な RAW 取込元上書きを保持するフォルダ。

  【ログ（重要）】
- 実行ログは output/logs/ に出力されます。
  - gui_app.log（回転ログ：肥大化しないよう自動でローテーション）
- エラーが発生した場合、画面に「ログフォルダを開きますか？」が表示されます。
  - 「はい」を選ぶと output/logs/ が開きます。
  - 問い合わせ時は gui_app.log を添付してください（原因特定が早くなります）。

【設定保存場所（重要）】
- GUI設定（端末ローカルの上書き）は local_overrides/ 配下に保存されます。
- output/ はCSV・ログ等の成果物専用として扱ってください（設定ファイルを置かない運用）。

4. 初期セットアップ（管理者向け）
--------------------

前提：
- 本ツールは「EXE配下に何も出力しない」運用に寄せています。
- 生成物・設定・ログは %LOCALAPPDATA%/BookingCurveLab/ 配下に集約されます。

(1) 初回起動（設定ファイルの自動展開）
1) BookingCurveLab.exe を起動します。
2) 初回起動時、設定一式が自動生成されます（例）：
   %LOCALAPPDATA%/BookingCurveLab/
     ├─ config/hotels.json
     ├─ output/
     ├─ acks/
     └─ local_overrides/

(2) hotels.json の最小設定（“まっさら配布”前提）
1) GUIの「マスタ設定」タブ →「設定フォルダを開く」から、config/hotels.json を開きます。
2) 初期テンプレは "setup_me" という仮IDになっています。
   - まずはこの "setup_me" を自ホテル用に書き換えてください（hotel_id / display_name / capacity 等）
3) raw_root_dir に、PMS RAW（N@FACE「売上予算実績表」）が継続保存されるフォルダを設定します。
   - 例：__PLEASE_SET_RAW_ROOT_DIR__ を実在パスに変更
4) 保存後、GUIの「設定を再読み込み」を押して反映します。

(3) ローカル上書き（任意）
- 端末ごとに RAW 取込元を変えたい場合：
  - local_overrides.json により「このPCだけ」RAWフォルダを上書きできます。
  - （運用上は、共有ではなく端末ごと独立が前提です）

(4) マスタ設定の数値（GUI側で調整）
- 予測キャップ（Forecast cap）
- 稼働率キャパ（Capacity）
※ここで保存した値は端末ローカルに保持されます。


5. 日常運用フロー（ざっくり）
--------------------

5-1. 日次〜週次（データ更新→欠損確認）
1) PMS RAW（売上予算実績表）が保存されるフォルダに、最新分が追加されていることを確認
2) BookingCurveLab を起動
3) 「マスタ設定」タブで daily snapshots を更新
   - 通常運用：RANGE_REBUILD（範囲限定更新）
   - 初期/整合性取り直し：FULL_ALL（全量更新：重いので注意）
4) 「欠損検査（ops）」を実行し、ERROR/WARN を確認
5) 確定欠損（今後も埋まらないもの）は「欠損一覧（運用）」で ACK（確認済み）にして運用集計から除外
   - 初期状態では「ACK済を非表示」がON（ノイズで麻痺しないため）
   - 必要に応じて「ACK済を非表示」をOFFにして全件確認できます

5-2. 月次（LT_DATA→カーブ確認）
1) 「ブッキングカーブ」タブで対象ホテルを選択
2) 「LT_DATA(4ヶ月)」または「LT_DATA(期間指定)」を実行
   → 以下を再生成
    ・lt_data_YYYYMM_<hotel>.csv（互換用：rooms）
    ・lt_data_rooms_YYYYMM_<hotel>.csv
    ・lt_data_pax_YYYYMM_<hotel>.csv
    ・lt_data_revenue_YYYYMM_<hotel>.csv
    ・monthly_curve_YYYYMM_<hotel>.csv
3) 「月次カーブ」タブで、最新月・前年同月のカーブを確認

5-3. モデル評価・フォーキャスト
1) 「モデル評価」タブで対象ホテル・期間を選択し、評価を更新
2) 「日別フォーキャスト」タブで最適モデルや誤差指標を確認



6. 画面（タブ）ごとの役割
--------------------

6-1. ブッキングカーブタブ

- 目的：曜日別の日次ブッキングカーブを確認する画面
- 主な操作：
  - ホテル
  - 対象月（YYYYMM）
  - 曜日
  を選び、「描画」を押す
- 「LT_DATA(4ヶ月)」/「LT_DATA(期間指定)」ボタンで
  - 時系列データ→LT_DATA CSV への変換
  - 月次カーブ CSV の生成
  を行う

6-2. 月次カーブタブ

- 目的：対象月＋近い前後月の月次ブッキングカーブを一覧で見る
- 使用データ：output/monthly_curve_YYYYMM_<hotel>.csv
- 特徴：すべて最新ASOFベースで描画し、宿泊月合計とグラフの最終値が一致する

6-3. 日別フォーキャストタブ

- 目的：1ヶ月分の日別 Forecast を確認する画面
- 内容：
  - 実績 vs 予測の一覧
  - 各日の OCC / ADR / RevPAR
  - 下部に「最適モデル（評価ベース）」「ASOF平均シナリオ」「近似ASOFシナリオ」

6-4. モデル評価タブ

- 目的：各モデル（avg / recent90 / recent90w / recent90_adj 等）の予測精度を比較
- 内容：
  - 直近12ヶ月、直近3ヶ月、前月など、期間を切り替えて
  - MAE / MAPE / バイアス / RMSE / サンプル数 を一覧表示
- 「最適モデル」は、この評価結果をもとに「指定した期間で最も MAE が小さいモデル」を選ぶイメージ。

6-5. ASOF比較タブ

- 目的：同じ宿泊月について、ASOF違いでブッキングカーブを比較
- 使いどころ：
  - 「この1週間でどれくらい進捗したか」
  - 「去年同時期と比べて、どのLT帯が取れているか」

6-6. マスタ設定タブ

- 目的：
  - daily snapshots / LT / 可視化 / 評価に入る前に、運用上の“前提条件”と“警告（運用）”を揃える
  - 「最新ASOF（観測値）」と「欠損検査（ops）の状態」を混同しない

- 設定・導線（迷子防止）：
  - 設定フォルダを開く：%LOCALAPPDATA%/BookingCurveLab/ を Explorer で開く
  - 設定を再読み込み：hotels.json を読み直して GUI に反映

- 主な機能（運用）：
  1) daily snapshots 更新（RAW→daily snapshots）
     - FULL_ALL（全量更新：危険・重い）
     - RANGE_REBUILD（範囲限定更新：通常運用の本命）
     - 失敗（layout_unknown 等）は推測で続行せず STOP（安全側）

  2) 欠損検査（ops：運用）
     - 日常運用向けの軽量チェック
     - 表示例：欠損検査：未実施（赤）／最終実施 YYYY-MM-DD HH:MM（ERROR:x / WARN:y）
     - 目的：いま手を打つべき欠損があるかの判断を早くする

  3) 欠損一覧（運用）
     - ops の ERROR/WARN を一覧で確認
     - ACK列をクリックして「確認済み」をトグル → 保存で端末ローカルに保持
     - 初期状態では「ACK済を非表示」がON（運用集計のノイズを除去するため）

  4) 欠損監査（audit：監査）
     - 全期間の状態確認（統制・品質把握）
     - 目的：全体像の把握（opsのACK除外は反映しない方針）

- 設定（ホテルごとのデフォルト条件）：
  - 予測キャップ（Forecast cap）
  - 稼働率キャパ（Capacity）



7. 評価指標の意味（現場への説明用）
--------------------

誤差 = 「予測 − 実績」で定義します。

7-1. バイアス（Bias / Mean Error）

- 定義：
  - 各日の「予測 − 実績」を平均したもの
- 何を見ているか：
  - 予測のクセ（攻めぎみか、守りぎみか）
- 解釈：
  - バイアス > 0  … 平均して高めに予測（攻め気味）
  - バイアス < 0  … 平均して低めに予測（守り気味）
  - バイアス ≒ 0 … 大きな偏りはない
- 一言：
  - 「バイアスは“予測のクセ”を見る数値。プラスなら攻めすぎ、マイナスなら守りすぎ。」

7-2. MPE（Mean Percentage Error）

- 定義：
  - 各日の誤差率 (予測 − 実績) / 実績 × 100 [%] を平均したもの
- 何を見ているか：
  - 平均で何％ぶん攻め/守りか
- 解釈：
  - MPE = +5% … 平均で5%高めに予測
  - MPE = −3% … 平均で3%低めに予測
- 一言：
  - 「MPE はバイアスの％版。＋なら何％ぶん攻めているか、−なら何％ぶん守っているかを見る。」

7-3. MAPE（Mean Absolute Percentage Error）

- 定義：
  - 各日の誤差率の絶対値の平均
    MAPE = 平均( |(予測 − 実績) / 実績| ) × 100
- 何を見ているか：
  - 外れ方の大きさ（％）※攻め/守りの向きは無視
- 解釈：
  - MAPE = 5%  … 平均すると ±5% 程度の誤差
  - MAPE = 12% … 平均誤差は ±12% 前後
- 一言：
  - 「MAPE は“どれくらいの割合で外れているか”を見る数値。方向は無視して、平均で何％くらいズレているかを把握する。」

7-4. RMSE（参考：現状は % ベースの rmse_pct）

注意：
- 現時点のアプリ表示は「誤差率（%）を元にした RMSE 相当（rmse_pct）」が中心です。
- “室数（rooms）ベースのRMSE” は、今後（売上予測も含めた評価設計の再考時）に改めて検討します。

- 定義（現状の参考）：
  - 各ASOFの誤差率 error_pct を二乗して平均し、その平方根を取ったもの（%）
    rmse_pct = sqrt( 平均( error_pct^2 ) )

- 特徴：
  - 大きな外しにやや敏感（外れが大きいASOFがあると数値が上がる）
  - 「%で見たときに、事故度合いがどの程度あるか」の参考になる

- 一言：
  - 「RMSE（%）は“大きな外し”にやや敏感な指標。現状は参考値として扱い、評価設計は後で再考する。」


7-5. 指標の使い分け

- バイアス / MPE
  → 予測の方向性のクセ（攻め / 守り）をチェック
- MAPE
  → 平均的な外れ具合を％で把握する
- RMSE（現状はrmse_pct）
  → %ベースで外れの大きさ・事故度合いの参考を見る（評価設計は後で再考）

アプリでは、

- モデル評価タブで「どのモデルが一番安定しているか」を見る
- 日別フォーキャストタブの右下でバイアス / MAPE を使って悲観 / 基準 / 楽観シナリオを算出

という使い方を想定している。


8. よくある質問（簡易）
--------------------

Q1. 月次カーブのグラフと、宿泊月の合計室数がズレることはある？

A. v0.6.3 以降は、時系列データをそのまま列合計しているので、基本的にズレない前提です。
もしズレて見えた場合は、

1. PMS 時系列Excelの中身（合計）
2. output/monthly_curve_YYYYMM_<hotel>.csv

を比較してください。それでもズレていれば、開発側へ相談してください。


Q2. LT_DATA を再生成しないと何が起きる？

A. 新しい時系列データが反映されません。

- ブッキングカーブタブ
- 月次カーブタブ
- モデル評価・フォーキャスト

はすべて lt_data_*.csv / monthly_curve_*.csv を見ているため、
時系列Excelを更新したら必ず LT_DATA を再生成してください。
