# ファイル名案: docs/thread_logs/2026-01-16_samp_main_icon-taskbar.md

# Thread Log: Windowsタスクバーアイコン（PyInstaller/Tkinter）反映と画質改善

## Meta

* Date: 2026-01-16（推定：会話中のZIP日付・時刻より）
* Branch: samp_main（推定：ZIP名より）
* Commit: 9dd8084（推定：ZIP名より）
* Zip:

  * rm-booking-curve-lab_20260116_1018_samp_main_4753107_full.zip
  * rm-booking-curve-lab_20260116_1132_samp_main_9dd8084_full.zip
* Scope:

  * Windows（主に10/11）におけるタスクバー/エクスプローラー/タスクマネージャーのアプリアイコン反映
  * ICO生成と画質（明度・にじみ）改善、キャッシュ/ショートカット/ピン留め挙動の切り分け

## Done（実装・変更）

* ImageMagick を導入し、PNG→ICO（16〜256px）生成フローを確立（identifyで内包サイズ確認）。
* ICO内包サイズ（16/20/24/32/40/48/64/128/256）を確認できる状態にした。
* 透過の有無を `channels=srgba` / `opaque=False` で確認し、透過自体は維持されていることを確認。
* 透過境界ノイズ/粗さ対策の候補として、alpha閾値処理（threshold）や軽い境界処理の案を提示。
* 暗く沈む問題に対し、`-gamma` / `-modulate` による明度調整の手順を提示し、ユーザー側で改善を確認。
* エクスプローラー表示の不一致がアイコンキャッシュ起因であることを確認（キャッシュ更新で整合）。
* タスクバーのみ羽アイコンになる個別PC問題を、ピン留め/ショートカット作成で解消できることを確認。
* 環境変数によるAppUserModelID切替テストを試行したが、当初はコード側で参照している環境変数キー不整合（スペース入り）が疑われた。
* 最終的に「ショートカット経由で起動」したことでタスクバー側が正しいアイコンを採用し、その後は羽に戻らない状態を確認。

## Decisions（決定）

* Decision:

  * アイコンの最終品質は、まず「同一デザインでICO化→EXE化→実機確認」を優先し、サイズ別最適化（別レンダリング）は後回し。
  * 暗さはガンマ/明度調整（ImageMagick）で補正し、他アプリと並べたときの違和感を低減する方針。
  * タスクバーの羽アイコン問題は、当面「ショートカット作成（必要ならピン留め）」で運用回避し、コード側の恒久対応は優先度を下げる。
* Why:

  * Windows側の表示系（Explorer/Taskbar/Taskmgr）で参照元・キャッシュ・合成が異なり、コード変更だけで完全に統一するのはコストが高い。
  * 実務上の再現性と手戻り最小化のため、まず確実に効く運用回避（ショートカット）を採用するのが合理的。
  * 画質課題はICO内のサイズ群と明度（中間調）調整の方が影響が大きく、デザイン分岐より先に効果が出る。

## Docs impact（反映先の候補）

* spec_overview: なし
* spec_data_layer: なし
* spec_models: なし
* spec_evaluation: なし
* BookingCurveLab_README: あり（運用メモとして）

### Docs impact 判定（必須/不要 + Status）

* 必須:

  * 項目: Windowsでタスクバーアイコンが反映されない/羽になる場合の回避策（ショートカット作成・ピン留め、アイコンキャッシュ）

    * 理由: 再現・サポート時に詰まりやすく、運用上の「正しい起動方法」を明確化する価値が高い
    * Status: 未反映
    * 反映先: BookingCurveLab_README（トラブルシュート節）
* docs不要:

  * 項目: spec_* への反映（データ/モデル/評価仕様）

    * 理由: 今回はUI/配布/OSキャッシュ挙動の作業であり、仕様（唯一の正）に影響しない

## Known issues / Open

* タスクバーは「非ピン留め・EXE直叩き」時に環境依存で既定（羽）に落ちることがある（OS側の紐付け/キャッシュ/ショートカット有無が影響）。
* Explorer/Taskbar/Taskmgr で、同一サイズに見えても参照するICOフレームや縮小・アルファ合成が異なり、見え方が変わり得る。
* （要確認）コード側でAppUserModelID用の環境変数キーがスペース入り（"BOOKING CURVE APP ID"）になっている可能性があり、`BOOKING_CURVE_APP_ID` が効かない疑い（恒久修正は未着手）。

## Next

* P0:

  * BookingCurveLab_README に「アイコン反映トラブルシュート（ショートカット作成/ピン留め/キャッシュ）」を追記する
* P1:

  * AppUserModelIDまわりの環境変数キー不整合がある場合は修正（`BOOKING_CURVE_APP_ID` を正としてfallback互換を付与）
  * ICOサイズ別最適化（32px専用の簡略版など）を検討（必要になった時点で対応）
